-- 1. Creati si instantiati baza de date cu toate restrictiile de integritate --

--Create table SALARIATI--
CREATE TABLE SALARIATI(
COD_ANGAJAT NUMBER PRIMARY KEY,
NUME VARCHAR2(70) NOT NULL,
CNP VARCHAR2(13) UNIQUE,
DESCRIERE_FUNCTIE VARCHAR2(70),
SALARIU_PE_ORA NUMBER(10,2) CHECK (SALARIU_PE_ORA>0)
);

--Create table PONTAJE--
CREATE TABLE PONTAJE(
COD_PROIECT NUMBER NOT NULL,
COD_ANGAJAT NUMBER NOT NULL,
COD_SECTIE NUMBER NOT NULL,
DURATA_EXEC_ZILE NUMBER NOT NULL CHECK(DURATA_EXEC_ZILE >=0),
NUMAR_ORE_ZILNIC NUMBER NOT NULL CHECK(NUMAR_ORE_ZILNIC BETWEEN 0 AND 24),
ABSENTE NUMBER DEFAULT 0 CHECK(ABSENTE >=0),
CONSTRAINT FK_PONTAJE_SALARIATI FOREIGN KEY (COD_ANGAJAT) REFERENCES SALARIATI(COD_ANGAJAT),
CONSTRAINT FK_PONTAJE_PROIECTE FOREIGN KEY (COD_PROIECT) REFERENCES PROIECTE(COD_PROIECT),
CONSTRAINT FK_PONTAJE_SECTII FOREIGN KEY (COD_SECTIE) REFERENCES SECTII(COD_SECTIE)
);

--Create table PROIECTE--
CREATE TABLE PROIECTE(
COD_PROIECT NUMBER PRIMARY KEY,
DENUMIRE_PROIECT VARCHAR2(150) NOT NULL,
BUGET NUMBER(15,2) CHECK(BUGET>=0)
);

--Create table SECTII--
CREATE TABLE SECTII(
COD_SECTIE NUMBER PRIMARY KEY,
NUME_SECTIE VARCHAR(50) NOT NULL,
TELEFON VARCHAR2(10),
LOCATIE VARCHAR(150),
BUGET NUMBER(15,2) CHECK (BUGET>=0)
);

--Create table RETINERI--
CREATE TABLE RETINERI(
COD_ANGAJAT NUMBER PRIMARY KEY,
RETINERE NUMBER(15,2) CHECK (RETINERE >=0),
CONSTRAINT FK_RETINERI_SALARIATI FOREIGN KEY (COD_ANGAJAT) REFERENCES SALARIATI(COD_ANGAJAT)
);

--Create tabele SEF DEPARTAMENT--
CREATE TABLE SEF_DEPARTAMENT(
COD_ANGAJAT NUMBER NOT NULL,
COD_SECTIE NUMBER NOT NULL,
CONSTRAINT PK_SEF_DEPARTAMENT PRIMARY KEY(COD_ANGAJAT,COD_SECTIE),
CONSTRAINT FK_SEF_DEPARTAMENT_SALARIATI FOREIGN KEY(COD_ANGAJAT) REFERENCES SALARIATI(COD_ANGAJAT),
CONSTRAINT FK_SEF_DEPARTAMENT_SECTII FOREIGN KEY(COD_SECTIE) REFERENCES SECTII(COD_SECTIE),
CONSTRAINT UQ_SEF_DEPARTAMENT_SECTIE UNIQUE(COD_SECTIE) -- Constrangere prin care o sectie poate avea un singur sef
);

SELECT TABLE_NAME 
FROM USER_TABLES 
WHERE TABLE_NAME = 'SALARIATI';

DROP TABLE SALARIATI CASCADE CONSTRAINTS;

SELECT TABLE_NAME 
FROM USER_TABLES 
WHERE TABLE_NAME = 'PONTAJE';

DROP TABLE PONTAJE CASCADE CONSTRAINTS;

-- Popularea tabelelor cu date --

-- TABELUL SALARIATI --
INSERT INTO SALARIATI VALUES(1,'Vasilescu Eduard','1830209410152','Operator calculator',30);
INSERT INTO SALARIATI VALUES(2,'Iacobescu Mihai','1980224160151','Operator calculator',30);
INSERT INTO SALARIATI VALUES(3,'Iacobescu Daniela','6000531166681','HR',20);
INSERT INTO SALARIATI VALUES(4,'Popa Gabriela','2920423100436','Customer support',25);
INSERT INTO SALARIATI VALUES(5,'Toma Mihnea','1970909034046','Programator',45);
INSERT INTO SALARIATI VALUES(6,'Simion Emanuel','1971225342479','Programator',45);
INSERT INTO SALARIATI VALUES(7,'Ghiorghe Gabriel','1950811035850','Programator',45);
INSERT INTO SALARIATI VALUES(8,'Mihailescu Ionela','2940531283899','Tester',35);
INSERT INTO SALARIATI VALUES(9,'Ivancu Luca','1920923283799','Tester',35);
INSERT INTO SALARIATI VALUES(10,'Boboc Irina','2961028260680','Technical Writer',35);
INSERT INTO SALARIATI VALUES(11,'Lomnasanu Adrian','1901028230258','Analist',30);
INSERT INTO SALARIATI VALUES(12,'Popa Mircea','1900228219109','UX/UI Designer',35);
INSERT INTO SALARIATI VALUES(13,'Patru Daiana','2900228129939','UX/UI Designer',35);

-- TABELUL SECTII --
INSERT INTO SECTII VALUES(1,'Sectia OC','0756341009','Brasov',54000);
INSERT INTO SECTII VALUES(2,'Sectia HR','0763447893','Brasov',39000);
INSERT INTO SECTII VALUES(3,'Sectia CS','0789668453','Brasov',41000);
INSERT INTO SECTII VALUES(4,'Sectia Dev','0776845346','Brasov',89000);
INSERT INTO SECTII VALUES(5,'Sectia Testare','0775822431','Brasov',120000);
INSERT INTO SECTII VALUES(6,'Sectia Tech','0756898009','Brasov',79900);
INSERT INTO SECTII VALUES(7,'Sectia Business','0771426778','Brasov',70000);
INSERT INTO SECTII VALUES(8,'Sectia UX/UI','0778567220','Brasov',89000);


-- TABELUL PROIECTE --
INSERT INTO PROIECTE VALUES(1,'Sisteme de planificare ?i management a resurselor companiei',34000);
INSERT INTO PROIECTE VALUES(2,'Sisteme de management al proiectelor',15000);
INSERT INTO PROIECTE VALUES(3,'Software de Business Intelligence',50000);
INSERT INTO PROIECTE VALUES(4,'Software de Resurse Umane (HRM)',45000);
INSERT INTO PROIECTE VALUES(5,'Aplica?ie de comer? electronic ',34000);
INSERT INTO PROIECTE VALUES(6,'Sisteme de management al documentelor (DMS)',43000);

-- TABELUL PONTAJE --
INSERT INTO PONTAJE VALUES(1,5,4,10,8,0);
INSERT INTO PONTAJE VALUES(2,7,4,14,8,1);
INSERT INTO PONTAJE VALUES(3,10,6,14,8,0);
INSERT INTO PONTAJE VALUES(4,11,7,21,8,3);
INSERT INTO PONTAJE VALUES(5,12,8,18,8,0);
INSERT INTO PONTAJE VALUES(6,13,8,12,8,0);


-- 2. Sa se calculeze salariile pe fiecare salariat --

CREATE OR REPLACE FUNCTION CALCULEAZA_SALARIU(COD_ANGAJAT_INPUT NUMBER) 
RETURN NUMBER IS
  SALARIU_TOTAL NUMBER := 0;
BEGIN
  -- Calculul salariului total pentru salariatul specificat--
  SELECT 
    SUM((P.NUMAR_ORE_ZILNIC * P.DURATA_EXEC_ZILE - P.ABSENTE * P.NUMAR_ORE_ZILNIC) * S.SALARIU_PE_ORA)
  INTO 
    SALARIU_TOTAL
  FROM 
    SALARIATI S
  JOIN 
    PONTAJE P ON S.COD_ANGAJAT = P.COD_ANGAJAT
  WHERE 
    S.COD_ANGAJAT = COD_ANGAJAT_INPUT
  GROUP BY 
    S.COD_ANGAJAT;

  -- Returneaza rezultatul--
  RETURN SALARIU_TOTAL;
EXCEPTION
  -- În caz de eroare sau lipsa date--
  WHEN NO_DATA_FOUND THEN
    RETURN NULL;
  WHEN OTHERS THEN
    RAISE_APPLICATION_ERROR(-20001, 'A aparut o eroare la calcularea salariului.');
END;
/

SELECT 
  S.COD_ANGAJAT,
  S.NUME,
  CALCULEAZA_SALARIU(S.COD_ANGAJAT) AS SALARIU_TOTAL
FROM 
  SALARIATI S;

-- 3. Calcularea manoperei pe sectie --

CREATE OR REPLACE FUNCTION CALCULEAZA_MANOPERA(COD_SECTIE_INPUT NUMBER) 
RETURN NUMBER IS
  MANOPERA_TOTAL NUMBER := 0;
BEGIN
  -- Calculul manoperei totale pentru sectia specificata--
  SELECT 
    SUM((P.NUMAR_ORE_ZILNIC * P.DURATA_EXEC_ZILE - P.ABSENTE * P.NUMAR_ORE_ZILNIC) * S.SALARIU_PE_ORA)
  INTO 
    MANOPERA_TOTAL
  FROM 
    SALARIATI S
  JOIN 
    PONTAJE P ON S.COD_ANGAJAT = P.COD_ANGAJAT
  WHERE 
    P.COD_SECTIE = COD_SECTIE_INPUT
  GROUP BY 
    P.COD_SECTIE;

  -- Returneaza rezultatul--
  RETURN MANOPERA_TOTAL;
EXCEPTION
  -- În caz de eroare sau lipsa date--
  WHEN NO_DATA_FOUND THEN
    RETURN NULL;
  WHEN OTHERS THEN
    RAISE_APPLICATION_ERROR(-20002, 'A aparut o eroare la calcularea manoperei.');
END;
/

SELECT 
  P.COD_SECTIE,
  CALCULEAZA_MANOPERA(P.COD_SECTIE) AS MANOPERA_TOTAL
FROM 
  PONTAJE P
GROUP BY 
  P.COD_SECTIE;



-- 4. Determinare muncitori cu cele mai mari salarii / cele mai mici salarii pe o anumita sectie si pe fiecare sectie in parte --

SELECT 
  P.COD_SECTIE,
  MAX((P.NUMAR_ORE_ZILNIC * P.DURATA_EXEC_ZILE - P.ABSENTE * P.NUMAR_ORE_ZILNIC) * S.SALARIU_PE_ORA) AS SALARIU_MAXIM,
  MIN((P.NUMAR_ORE_ZILNIC * P.DURATA_EXEC_ZILE - P.ABSENTE * P.NUMAR_ORE_ZILNIC) * S.SALARIU_PE_ORA) AS SALARIU_MINIM
FROM 
  SALARIATI S
JOIN 
  PONTAJE P ON S.COD_ANGAJAT = P.COD_ANGAJAT
GROUP BY 
  P.COD_SECTIE;


-- 5. Calcularea retinerilor --

CREATE OR REPLACE FUNCTION CALCULEAZA_RETINERI(
  p_cod_angajat IN NUMBER DEFAULT NULL -- Codul angajatului; NULL pentru toti angajatii--
)
RETURN NUMBER IS
  suma_retineri NUMBER := 0; -- Variabila pentru suma totala a retinerilor--
BEGIN
  -- Verifica daca se calculeaza pentru un angajat specific sau pentru toti angajatii--
  IF p_cod_angajat IS NOT NULL THEN
    -- Calcul pentru un angajat specific--
    SELECT NVL(SUM(P.ABSENTE * S.SALARIU_PE_ORA), 0)
    INTO suma_retineri
    FROM PONTAJE P
    JOIN SALARIATI S ON P.COD_ANGAJAT = S.COD_ANGAJAT
    WHERE P.COD_ANGAJAT = p_cod_angajat;
  ELSE
    -- Calcul pentru toti angajatii--
    SELECT NVL(SUM(P.ABSENTE * S.SALARIU_PE_ORA), 0)
    INTO suma_retineri
    FROM PONTAJE P
    JOIN SALARIATI S ON P.COD_ANGAJAT = S.COD_ANGAJAT;
  END IF;

  -- Returneaza suma calculata--
  RETURN suma_retineri;
END;
/

SELECT CALCULEAZA_RETINERI() AS RETINERI_TOTAL
FROM DUAL;



